{% extends "base.html" %}

{% block title %}Мои результаты - Stepik Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h1 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Мои результаты
                </h1>
                <p class="mb-0 mt-2">Статистика и детальная информация по всем тестам</p>
            </div>
        </div>
    </div>
</div>

<!-- Общая статистика -->
<div class="row mt-4">
    {% set total_score = tests | selectattr('is_reviewed') | map(attribute='score') | sum %}
    {% set reviewed_count = tests | selectattr('is_reviewed') | list | length %}
    {% set pending_count = tests | rejectattr('is_reviewed') | list | length %}
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                <h3 class="stats-number">{{ total_score }}</h3>
                <p class="mb-0">Всего баллов</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                <h3 class="stats-number">{{ tests | length }}</h3>
                <p class="mb-0">Всего тестов</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h3 class="stats-number">{{ reviewed_count }}</h3>
                <p class="mb-0">Проверено</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                <h3 class="stats-number">{{ pending_count }}</h3>
                <p class="mb-0">На проверке</p>
            </div>
        </div>
    </div>
</div>

<!-- Прогресс -->
{% if tests | length > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Прогресс выполнения
                </h4>
            </div>
            <div class="card-body">
                {% set completion_percentage = (reviewed_count / tests | length * 100) | round(1) if tests | length > 0 else 0 %}
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ completion_percentage }}%">
                        {{ completion_percentage }}%
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-md-6">
                        <h5 class="text-success">{{ reviewed_count }}</h5>
                        <p class="mb-0">Проверенных тестов</p>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-info">{{ pending_count }}</h5>
                        <p class="mb-0">Ожидающих проверки</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Список тестов -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Все тесты
                </h4>
            </div>
            <div class="card-body">
                {% if tests %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Степик ID</th>
                                <th>Тип</th>
                                <th>Статус</th>
                                <th>Баллы</th>
                                <th>Комментарий</th>
                                <th>Дата отправки</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in tests %}
                            <tr class="{{ 'table-success' if test.is_reviewed and test.score > 0 else 'table-warning' if not test.is_reviewed else 'table-danger' if test.is_reviewed and test.score == 0 else '' }}">
                                <td><strong>#{{ test.id }}</strong></td>
                                <td>{{ test.full_name }}</td>
                                <td><code>{{ test.stepik_id }}</code></td>
                                <td>
                                    <span class="badge bg-{{ 'primary' if test.test_type == '5' else 'info' }}">
                                        {{ test.test_type }} баллов
                                    </span>
                                </td>
                                <td>
                                    {% if test.is_reviewed %}
                                        {% if test.score > 0 %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Засчитан
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Не засчитан
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>На проверке
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.is_reviewed %}
                                        <span class="badge bg-{{ 'success' if test.score > 0 else 'danger' }} fs-6">
                                            {{ test.score }}/{{ test.test_type }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.is_reviewed and test.teacher_comment %}
                                        <span class="text-muted" title="{{ test.teacher_comment }}">
                                            <i class="fas fa-comment me-1"></i>
                                            {{ test.teacher_comment[:30] }}{{ '...' if test.teacher_comment|length > 30 else '' }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ test.submitted_at.split(' ')[0] if test.submitted_at else '—' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ test.test_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        {% if test.is_reviewed and test.teacher_comment %}
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="showComment('{{ test.teacher_comment | replace("'", "\\'") }}')">
                                            <i class="fas fa-comment"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">У вас пока нет отправленных тестов</h5>
                    <p class="text-muted">Начните с отправки первого теста!</p>
                    <a href="{{ url_for('submit_test') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Отправить тест
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Быстрые действия -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Быстрые действия
                </h4>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="{{ url_for('submit_test') }}" class="btn btn-primary btn-lg me-md-2">
                        <i class="fas fa-plus me-2"></i>
                        Отправить новый тест
                    </a>
                    <a href="{{ url_for('student_dashboard') }}" class="btn btn-outline-primary btn-lg me-md-2">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Панель студента
                    </a>
                    <button class="btn btn-outline-info btn-lg" onclick="exportResults()">
                        <i class="fas fa-download me-2"></i>
                        Экспорт результатов
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Легенда -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Легенда
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-check-circle me-2 text-success"></i>Засчитан:</h6>
                        <p class="text-muted">Тест проверен и засчитан преподавателем</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-times-circle me-2 text-danger"></i>Не засчитан:</h6>
                        <p class="text-muted">Тест проверен, но не засчитан (0 баллов)</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-clock me-2 text-warning"></i>На проверке:</h6>
                        <p class="text-muted">Тест отправлен и ожидает проверки</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showComment(comment) {
    alert('Комментарий преподавателя:\n\n' + comment);
}

function exportResults() {
    // Простой экспорт в текстовом формате
    let exportText = 'МОИ РЕЗУЛЬТАТЫ ПО ТЕСТАМ\n';
    exportText += '=' + '='.repeat(30) + '\n\n';
    
    {% for test in tests %}
    exportText += 'Тест #{{ test.id }}\n';
    exportText += 'ФИО: {{ test.full_name }}\n';
    exportText += 'Степик ID: {{ test.stepik_id }}\n';
    exportText += 'Тип: {{ test.test_type }} баллов\n';
    exportText += 'Статус: {% if test.is_reviewed %}{% if test.score > 0 %}Засчитан{% else %}Не засчитан{% endif %}{% else %}На проверке{% endif %}\n';
    {% if tests | length > 0 %}
    exportText += 'Баллы: {% if test.is_reviewed %}{{ test.score }}/{{ test.test_type }}{% else %}—{% endif %}\n';
    {% endif %}
    exportText += 'Дата: {{ test.submitted_at.split(" ")[0] if test.submitted_at else "—" }}\n';
    exportText += 'Ссылка: {{ test.test_url }}\n';
    {% if test.is_reviewed and test.teacher_comment %}
    exportText += 'Комментарий: {{ test.teacher_comment }}\n';
    {% endif %}
    exportText += '\n' + '-'.repeat(40) + '\n\n';
    {% endfor %}
    
    // Создаем и скачиваем файл
    const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'my_test_results.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
